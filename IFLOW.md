# ESP32C3 BLE鼠标项目 - iFlow上下文文档

## 项目概述

这是一个基于ESP32C3芯片的BLE（蓝牙低功耗）鼠标项目，使用Arduino框架开发。该项目实现了一个完整的HID设备，能够模拟鼠标移动行为，具有自然的人类移动模式，包括移动和停顿的随机周期。

### 主要特性
- BLE HID鼠标功能，无点击动作，仅模拟移动
- 基于状态机的设备管理，支持多种工作状态
- 自然鼠标移动模式：随机漫步、圆形轨迹、8字形轨迹
- 智能移动停顿周期：移动时间1-4秒随机，停顿时间0.5-3秒随机
- LED状态指示系统，直观显示设备当前状态
- 自动重连机制，支持已配对设备的快速连接

### 技术栈
- **硬件平台**: ESP32C3 (AirM2M CORE ESP32C3)
- **开发框架**: Arduino
- **蓝牙库**: NimBLE-Arduino
- **状态机库**: TinyFSM
- **编译标准**: C++11
- **构建系统**: PlatformIO

## 项目结构

```
esp32c3_ble_mouse/
├── src/
│   ├── main.cpp              # 主程序文件，包含BLE初始化和主循环逻辑
│   ├── state_machine.cpp     # 状态机实现文件
│   ├── state_machine.h       # 状态机头文件，定义所有状态和事件
│   └── led_controller.cpp    # LED控制器实现文件
├── include/
│   └── led_controller.h      # LED控制器头文件
├── platformio.ini            # PlatformIO项目配置文件
├── README.md                 # 项目说明文档
└── IFLOW.md                  # 本文档，iFlow上下文说明
```

## 构建和运行

### 环境要求
- PlatformIO CLI或IDE
- 支持的ESP32C3开发板（AirM2M CORE ESP32C3）
- USB数据线用于烧录和调试

### 编译命令
```bash
# 编译项目
platformio run --environment airm2m_core_esp32c3

# 烧录到设备
platformio run --target upload --environment airm2m_core_esp32c3

# 监视串口输出
platformio device monitor --baud 115200
```

### 项目配置
项目配置在`platformio.ini`中定义：
- 目标开发板：`airm2m_core_esp32c3`
- 串口波特率：115200
- 主要依赖：NimBLE-Arduino、TinyFSM
- 编译标志：启用NimBLE，配置蓝牙连接参数

## 开发约定

### 代码结构
- **状态机模式**: 使用TinyFSM库实现完整的状态机管理
- **面向对象**: LED控制采用静态类设计
- **模块化**: 功能按模块分离，便于维护

### 状态机设计
项目使用状态机管理设备生命周期，主要状态包括：
- **Init**: 系统初始化状态
- **Idle**: 空闲状态，设备可被发现和连接
- **Reconnect**: 重连状态，尝试连接已配对设备
- **Pairing**: 配对状态，允许新设备连接
- **Connected**: 连接状态，设备已连接但鼠标移动禁用
- **MouseMotionDisable**: 鼠标移动禁用状态
- **MouseMotionEnable**: 鼠标移动启用状态

### LED指示系统
LED状态是设备状态的重要指示：
- **熄灭**: Init状态或Idle状态
- **同步闪烁1Hz**: Reconnect状态
- **同步闪烁3Hz**: Pairing状态
- **常亮**: Connected状态或MouseMotionDisable状态
- **交替闪烁2Hz**: MouseMotionEnable状态

### 鼠标移动算法
实现了三种自然移动模式：
1. **随机漫步模式**: 模拟人类随机浏览行为
2. **圆形轨迹模式**: 平滑的圆形运动轨迹
3. **8字形轨迹模式**: 复杂的8字运动轨迹

移动特性：
- 平滑速度过渡，模拟人体动作惯性
- 微小随机扰动，模拟手部自然抖动
- 随机移动周期：1-4秒移动，0.5-3秒停顿
- 无点击动作，仅移动模拟

### 按键交互
- **BOOT按键**: GPIO9，低电平有效
- **短按(<1秒)**: 切换鼠标移动开关
- **长按(≥5秒)**: 进入配对模式

### 调试和日志
- 串口波特率：115200
- 状态转换和事件处理都有详细日志输出
- 鼠标移动参数变化实时显示

## 核心文件说明

### main.cpp
主程序文件，包含：
- BLE HID设备初始化和配置
- HID报告描述符定义
- 按键事件处理逻辑
- 鼠标移动算法实现
- 主循环和状态管理

### state_machine.h/cpp
状态机实现，包含：
- 所有状态类定义和事件处理
- 状态转换逻辑
- LED状态控制
- 连接管理逻辑

### led_controller.h/cpp
LED控制器，提供：
- 多种LED模式（常亮、闪烁、交替等）
- 状态指示映射
- 简化的LED控制接口

## 常见开发任务

### 添加新的鼠标移动模式
1. 在`main.cpp`的移动算法中添加新的case
2. 更新`currentPattern`的随机范围
3. 可能需要调整移动参数

### 修改LED指示逻辑
1. 在对应状态的`entry()`方法中修改LED设置
2. 或在`led_controller.h/cpp`中添加新的LED模式
3. 更新状态机中的LED控制调用

### 调整移动参数
- 修改`state_machine.h`中的时间常量
- 调整`main.cpp`中的移动算法参数
- 重新编译并测试效果

### 添加新的BLE功能
1. 在HID报告描述符中添加新的报告
2. 在主循环中添加相应的数据处理逻辑
3. 更新状态机以支持新功能

## 故障排除

### 编译问题
- 确保安装了所有依赖库
- 检查PlatformIO版本兼容性
- 验证开发板配置正确

### 连接问题
- 检查设备是否正确进入配对模式
- 确保目标设备支持BLE HID
- 验证蓝牙权限设置

### 移动问题
- 检查鼠标移动是否已启用
- 验证BLE连接状态
- 查看串口日志中的移动参数

## 性能优化

### 内存使用
- 当前Flash使用率：约39.3%
- 当前RAM使用率：约7.1%
- 仍有较大优化空间

### 功耗优化
- 可考虑在空闲状态降低CPU频率
- 优化BLE广播参数以减少功耗
- 在停顿阶段可进一步降低活动频率

## 扩展建议

1. **添加滚轮支持**: 扩展HID报告描述符
2. **电池管理**: 添加电池电量监测和报告
3. **配置存储**: 添加参数持久化存储
4. **移动模式定制**: 允许用户自定义移动模式
5. **OTA更新**: 添加无线固件更新功能